# 派对智能重启功能

## 功能概述

为了解决派对24小时强制关闭导致用户被踢出的问题，我们实现了智能派对重启功能。当派对运行超过12小时后，系统会监控派对人数，一旦只剩下群主一个人时，主动关闭并重新开启派对。

## 实现原理

### 1. 时间监控
- 派对运行超过配置时间后，启用智能重启功能
- 支持分钟级精确控制，便于测试
- 只在12:00-24:00时间段内进行监控（避免深夜频繁操作）

### 2. 人数监控
- 实时监控派对人数
- 当检测到只有1人（群主）时，触发重启流程

### 3. 重启流程
1. 结束当前派对
2. 等待3秒确保派对完全关闭
3. 创建新派对
4. 设置默认notice

### 4. 架构设计
- 所有派对管理逻辑集中在PartyManager中
- EndCommand只负责命令处理，委托业务逻辑给Manager
- 单一职责原则，避免代码重复

## 代码结构

### PartyManager (src/managers/party_manager.py)
- `initialize()`: 初始化派对管理器
- `update()`: 主要的派对监控和管理逻辑
- `create_party()`: 创建新派对
- `restart_party()`: 重启派对（结束+创建）
- `get_party_user_count()`: 获取当前派对人数
- `is_party_active()`: 检查派对是否活跃
- 管理所有派对相关状态（触发时间、重启状态等）

### EndCommand (src/commands/end.py)
- `process()`: 处理手动结束派对命令
- `end_party()`: 执行结束派对操作
- `update()`: 委托给PartyManager处理自动管理逻辑
- 简化为纯命令处理，不包含业务逻辑

## 配置参数

### config.yaml中的配置
```yaml
soul:
  party_restart_minutes: 720        # 触发重启的时间（分钟），默认12小时=720分钟
```

### 配置说明
- `party_restart_minutes`: 派对运行多长时间后开始监控并重启（分钟）
- 默认值：720分钟（12小时）
- 测试时可以将此值改小，如5分钟进行快速测试

## 工作流程

1. **初始化阶段** (0-配置时间)
   - 正常监控，不启用重启功能
   - 保持原有逻辑不变

2. **智能监控阶段** (配置时间+)
   - 启用派对重启功能
   - 每轮监控检查人数
   - 如果只有1人，则重启派对

3. **重启执行阶段**
   - 执行重启流程
   - 继续监控（无冷却期）

## 日志记录

系统会记录以下关键信息：
- 智能重启功能启用
- 人数检测结果
- 重启操作执行
- 重启成功/失败状态
- 冷却时间状态

## 优势

1. **避免强制关闭**: 在24小时限制前主动重启
2. **保护用户体验**: 不会踢掉派对中的用户
3. **智能监控**: 只在必要时重启
4. **配置简单**: 只需一个配置项，易于维护
5. **向后兼容**: 不影响现有功能

## 测试方法

要测试功能是否有效，您可以：

1. **修改配置**：
   ```yaml
   party_restart_minutes: 5  # 改为5分钟进行快速测试
   ```

2. **启动系统**，等待5分钟

3. **观察日志**，应该看到：
   - "派对重启功能已启用，触发时间: 5分钟"
   - "派对运行超过5分钟，启用智能重启功能"
   - 当只有1人时："检测到只有1人在派对中，准备重启派对..."

4. **测试完成后**，将配置改回720分钟

## 注意事项

1. 重启功能只在12:00-24:00时间段内生效
2. 需要确保Soul应用正常运行
3. 重启过程中可能会有短暂的服务中断
4. 测试时建议使用较短的触发时间

## 测试验证

已通过以下测试：
- ✅ 时间计算逻辑
- ✅ 人数解析逻辑  
- ✅ 冷却时间逻辑
- ✅ 重启流程逻辑

## 未来优化

1. 可配置的重启时间阈值
2. 更智能的人数检测
3. 重启失败重试机制
4. 用户通知功能
